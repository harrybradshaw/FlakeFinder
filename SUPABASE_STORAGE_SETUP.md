# Supabase Storage Setup for Screenshots

This guide explains how to set up Supabase Storage to store test screenshots instead of using base64 encoding.

## Benefits

- **ðŸ”’ Secure**: Private bucket with signed URLs - only your API can generate access links
- **ðŸ“‰ Reduced database size**: Images stored separately from database
- **âš¡ Better performance**: Faster queries and page loads
- **ðŸŒ CDN delivery**: Images served via Supabase CDN
- **ðŸ’° Cost effective**: Storage is cheaper than database space
- **â±ï¸ Time-limited access**: Signed URLs expire (configurable, default 1 year)
- **ðŸš« No direct access**: Users cannot browse or access bucket directly

## Setup Steps

### 1. Create Storage Bucket in Supabase

1. Go to your Supabase project dashboard
2. Navigate to **Storage** in the left sidebar
3. Click **Create a new bucket**
4. Configure the bucket:
   - **Name**: `test-screenshots`
   - **Public bucket**: âŒ No (private bucket for security)
   - **File size limit**: 50MB (or as needed)
   - **Allowed MIME types**: `image/png, image/jpeg, image/jpg`

### 2. Set Storage Policies

Since we're using a **private bucket with signed URLs**, we only need policies for the service role to upload and manage files:

```sql
-- Allow service role to upload screenshots
CREATE POLICY "Service role upload"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'test-screenshots' 
  AND auth.role() = 'service_role'
);

-- Allow service role to read (for generating signed URLs)
CREATE POLICY "Service role read"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'test-screenshots'
  AND auth.role() = 'service_role'
);

-- Allow service role to delete (for cleanup)
CREATE POLICY "Service role delete"
ON storage.objects FOR DELETE
TO authenticated
USING (
  bucket_id = 'test-screenshots'
  AND auth.role() = 'service_role'
);
```

Or use the Supabase UI:
1. Go to **Storage** > **Policies**
2. Click **New Policy** on `test-screenshots` bucket
3. Select **"For full customization"**
4. Add policies for INSERT, SELECT, and DELETE
5. Target roles: `authenticated`
6. Add condition: `auth.role() = 'service_role'`

**Note**: No public access policy needed! Users access screenshots via signed URLs generated by your API.

### 3. Configure Environment Variables

Add to your `.env.local`:

```bash
# Supabase (you should already have these)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key

# Service Role Key (required for storage uploads)
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

**Important**: The `SUPABASE_SERVICE_ROLE_KEY` is different from the anon key:
- Go to **Settings** > **API** in Supabase dashboard
- Copy the **service_role** key (not the anon key)
- This key has admin privileges, so **never expose it to the client**

### 4. Test the Setup

Upload a test report and check:

1. Screenshots should upload to Supabase Storage
2. Check the console logs for: `"Uploaded screenshot to Supabase Storage: https://..."`
3. Verify in Supabase dashboard: **Storage** > **test-screenshots** bucket
4. Screenshots should be viewable in the test details page

### 5. Fallback Behavior

If Supabase Storage is not configured, the system automatically falls back to base64 encoding:
- Screenshots will be stored as base64 strings in the database
- You'll see: `"Supabase Storage not configured, using base64 encoding"`

## Storage Structure

Screenshots are organized as:
```
test-screenshots/
  screenshots/
    1234567890-screenshot-1.png
    1234567891-screenshot-2.png
    ...
```

Each file is prefixed with a timestamp to ensure uniqueness.

## Migration from Base64

If you have existing screenshots stored as base64, you can migrate them:

```sql
-- Find tests with base64 screenshots
SELECT id, screenshots 
FROM tests 
WHERE screenshots::text LIKE '%data:image%'
LIMIT 10;
```

Migration would require:
1. Extracting base64 data
2. Decoding to binary
3. Uploading to Supabase Storage
4. Updating database with new URLs

This is optional - new uploads will use storage automatically.

## Monitoring

Check storage usage:
1. Go to **Settings** > **Usage** in Supabase
2. View **Storage** metrics
3. Set up alerts if needed

## Cleanup

To delete old screenshots (optional):

```sql
-- Find tests older than 90 days
SELECT t.id, t.screenshots, tr.timestamp
FROM tests t
JOIN test_runs tr ON t.test_run_id = tr.id
WHERE tr.timestamp < NOW() - INTERVAL '90 days'
AND t.screenshots IS NOT NULL;
```

You can create a cleanup job to delete old storage files and database records.

## Troubleshooting

### "Failed to upload to Supabase Storage"

**Check:**
1. `SUPABASE_SERVICE_ROLE_KEY` is set correctly
2. Bucket `test-screenshots` exists
3. Storage policies allow uploads
4. File size is within limits

### Screenshots not displaying

**Check:**
1. Bucket is set to **public**
2. Public read policy exists
3. URLs are correct in database
4. CORS settings if needed

### Performance issues

**Solutions:**
1. Enable CDN caching (already set: `cacheControl: '3600'`)
2. Use image optimization
3. Implement lazy loading for screenshots
4. Consider image compression before upload

## Cost Estimation

Supabase Storage pricing (as of 2024):
- **Free tier**: 1GB storage, 2GB bandwidth
- **Pro tier**: $0.021/GB storage, $0.09/GB bandwidth

Example:
- 1000 screenshots Ã— 500KB each = 500MB storage
- Cost: ~$0.01/month storage + bandwidth costs

Much cheaper than storing in database!
